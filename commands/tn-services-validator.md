---
description: Validate frontend TN services against the backend OpenAPI schema
allowed-tools: Read, Grep, Glob, Bash(just openai-schema), Bash(cd server && uv run python manage.py spectacular*), Bash(git diff:*), Bash(git log:*), mcp__tnm-openapi__get_routes, mcp__tnm-openapi__get_route, mcp__tnm-openapi__get_schema, mcp__tnm-openapi__get_entities, Write
argument-hint: [service-name | --all | --pr]
---

# TN Services Validator Command

Validate that frontend TN-models service definitions match the backend OpenAPI schema generated by drf-spectacular. This helps catch API contract mismatches early.

## Arguments

- `<service-name>`: Validate a specific service (e.g., `sessions`, `participants`, `projects`)
- `--all`: Validate all services in `client/src/services/`
- `--pr`: Validate only services changed in the current PR/branch (compares against main)

## Instructions

### Step 1: Identify Services to Validate

**First, determine which services need validation based on `$ARGUMENTS`:**

#### If `--all`:
List all service directories:
```bash
ls -d client/src/services/*/
```
This gives you all available services to validate.

#### If a specific service name (e.g., `sessions`):
Target only that service: `client/src/services/<service-name>/api.ts`

#### If `--pr`:
Identify changed services from the current PR/branch:

1. Get the list of changed files compared to main:
   ```bash
   git diff main...HEAD --name-only
   ```

2. Filter for service-related files:
   - Files matching `client/src/services/*/api.ts`
   - Files matching `client/src/services/*/models.ts`
   - Files matching `client/src/services/*/queries.ts`
   - Backend files matching `server/quadrant/*/views.py`
   - Backend files matching `server/quadrant/*/serializers.py`

3. Extract the service names from the changed paths:
   - For `client/src/services/sessions/api.ts` → service name is `sessions`
   - For `server/quadrant/participants/views.py` → find corresponding frontend service

4. Also check for backend model/serializer changes that might affect the API contract:
   - If `server/quadrant/*/serializers.py` changed, identify which services use those endpoints
   - If `server/quadrant/*/models.py` changed, check for schema changes

5. Add `changed_in_pr: true` flag to the report for affected services

**Output of this step**: A list of service names to validate (e.g., `['sessions', 'participants', 'projects']`)

### Step 2: Generate the OpenAPI Schema

Run the Django management command to generate a fresh OpenAPI schema:

```bash
just openai-schema --file /tmp/openapi-schema.yaml
```

or

```bash
cd server && uv run python manage.py spectacular --file /tmp/openapi-schema.yaml
```

This creates the schema file at `/tmp/openapi-schema.yaml`.

### Step 3: For Each Service, Validate:

#### 3a. Read the Service API File
Read `client/src/services/<service>/api.ts` and extract:
- `baseUri` from the `createApi` call
- All CRUD methods enabled (list, retrieve, create, update, remove)
- Custom service calls (`createCustomServiceCall`)

#### 3b. Read the Service Models File
Read `client/src/services/<service>/models.ts` and extract:
- Entity shape fields (the main Zod schema)
- Create shape fields
- Filter shape fields

#### 3c. Get Backend Route Details
For the corresponding backend routes, use:

```
mcp__tnm-openapi__get_route(schema_path="/tmp/openapi-schema.yaml", route_path="/api/<baseUri>/")
```

**Note**: Only fetch routes for the specific services being validated - do NOT use `get_routes` to fetch all routes as this overloads context.

#### 3d. Get Backend Schema Details
For entity schemas, use:

```
mcp__tnm-openapi__get_schema(schema_path="/tmp/openapi-schema.yaml", schema_name="<EntityName>")
```

Use the Service to Backend Route Mapping table below to determine the schema name for each service.

### Step 4: Compare and Report Issues

For each service, check:

1. **Endpoint Existence**: Does the frontend baseUri match a backend route?
2. **HTTP Methods**: Are the frontend methods (GET, POST, PATCH, DELETE) supported by the backend?
3. **Field Matching**: Do the frontend Zod shape fields match the backend schema properties?
4. **Required Fields**: Are required fields in the backend marked correctly in the frontend?
5. **Field Types**: Do field types match (string, number, boolean, array, etc.)?
6. **Custom Calls**: Do custom service call endpoints exist in the backend?

### Step 5: Output Report

Write the validation report to `docs/tn-services-validation-report.md`:

```markdown
# TN Services Validation Report
Generated: [timestamp]
Schema: /tmp/openapi-schema.yaml
Mode: [all | pr | <service-name>]

## Summary
- Services Validated: X
- Passed: Y
- Issues Found: Z

## Service: sessions
**Base URI**: `sessions/`
**Status**: ✅ PASS | ⚠️ WARNINGS | ❌ FAIL
**Changed in PR**: Yes/No (only shown in --pr mode)

### Endpoints
| Frontend | Backend | Status |
|----------|---------|--------|
| GET /sessions/ | ✅ Found | PASS |
| POST /sessions/ | ✅ Found | PASS |
| GET /sessions/:id/ | ✅ Found | PASS |

### Entity Fields
| Field | Frontend Type | Backend Type | Status |
|-------|---------------|--------------|--------|
| id | z.string().uuid() | string (uuid) | ✅ MATCH |
| name | z.string() | string | ✅ MATCH |
| datetime | z.string() | string (date-time) | ✅ MATCH |
| missingField | - | string | ❌ MISSING |

### Custom Calls
| Call | Endpoint | Status |
|------|----------|--------|
| getTimezones | GET /sessions/timezones/ | ✅ Found |
| addParticipants | POST /session-participants/ | ✅ Found |

### Issues
- ❌ Field `missingField` exists in backend but not in frontend entity shape
- ⚠️ Field `optionalField` is required in backend but optional in frontend

---

## Service: participants
...
```

## Service to Backend Route Mapping

Common mappings between frontend services and backend routes:

| Frontend Service | Backend Route Prefix | Schema Name |
|-----------------|---------------------|-------------|
| sessions | /api/sessions/ | Session |
| session-participants | /api/session-participants/ | SessionParticipant |
| participants | /api/participants/ | ParticipantDetail |
| projects | /api/projects/ | Project |
| reports | /api/reports/ | Report |
| report-participants | /api/report-participants/ | ReportParticipant |
| quotas | /api/quotas/ | Quota |
| quota-participants | /api/quota-participants/ | QuotaParticipant |
| project-participant | /api/project-participations/ | ProjectParticipant |
| payments | /api/payments/jobs/ | PaymentJob |
| email-templates | /api/email/email-templates/ | EmailTemplate |
| workstreams | /api/workstreams/ | Workstream |
| user | /api/users/ | User |
| signature-documents | /api/signature-documents/ | SignatureDocument |
| surveys | /api/surveys/ | DecipherSurvey |
| survey-responses | /api/survey-responses/ | ParticipantSurveyResponse |
| client | /api/clients/ | Client |
| company | /api/companies/ | Company |
| company-history | /api/company-history/ | CompanyHistory |
| participant-panel | /api/participant-panels/ | ParticipantPanel |
| panel-membership | /api/panel-memberships/ | PanelMembership |
| policy-expertise | /api/policy-expertise/ | PolicyExpertise |
| tech-expertise | /api/tech-expertise/ | TechExpertise |
| participant-filters | /api/participant-filters/ | ParticipantFilter |
| project-participation-statuses | /api/project-participation-statuses/ | ProjectParticipationStatus |
| sent-email-logs | /api/email/sent-email-logs/ | SentEmailLog |

## Type Mapping Reference

| Zod Type | OpenAPI Type |
|----------|--------------|
| z.string() | string |
| z.string().uuid() | string (format: uuid) |
| z.string().datetime() | string (format: date-time) |
| z.string().email() | string (format: email) |
| z.number() | integer or number |
| z.boolean() | boolean |
| z.array() | array |
| z.object() | object |
| z.enum() | enum |
| z.nativeEnum() | enum |
| z.nullable() | nullable: true |
| z.optional() | required: false |

## Example Validation

For `client/src/services/sessions/api.ts`:

```typescript
export const sessionApi = createApi({
  client: axiosInstance,
  baseUri: 'sessions/',
  models: {
    entity: sessionDetailShape,
    create: createSessionShape,
    extraFilters: sessionFilterShape,
  },
  customCalls: {
    getTimezones,
  },
})
```

The validator will:
1. Check `/api/sessions/` exists in OpenAPI schema
2. Verify GET, POST, PATCH, DELETE are supported
3. Compare `sessionDetailShape` fields with `Session` schema
4. Verify `/api/sessions/timezones/` endpoint exists for the custom call
